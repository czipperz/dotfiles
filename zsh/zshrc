# -*- shell-script -*-
[[ $- != *i* ]] && return

#############################
### Environment variables ###
#############################

autoload -U colors && colors

# Path to your oh-my-zsh installation.
export ZSH=/home/czipperz/.oh-my-zsh

ZSH_THEME="czipperz"

ENABLE_CORRECTION="true"

# DISABLE_UNTRACKED_FILES_DIRTY="true"

plugins=(sudo)

# User configuration

setopt interactivecomments

export PATH=/bin:/usr/bin:/usr/local/bin:/usr/local/sbin:/usr/bin:/usr/bin/site_perl:/usr/bin/vendor_perl:/usr/bin/core_perl:/home/czipperz/.gem/ruby/2.2.0/bin:/home/czipperz/.perl6/2015.03/bin:/home/czipperz/.cargo/bin
export RUST_SRC_PATH=/home/czipperz/abs/rust/src

fpath=( $HOME/.oh-my-zsh/functions $fpath )

source $ZSH/oh-my-zsh.sh

EDITOR="emacsclient -t"
export EDITOR

bindkey -v
export KEYTIMEOUT=1

function zle-line-init zle-keymap-select {
    RPS1="${${KEYMAP/vicmd/-- NORMAL --}/(main|viins)/-- INSERT --} $EPS1"
    zle reset-prompt
}
zle -N zle-line-init
zle -N zle-keymap-select

bindkey '^P' up-history
bindkey '^N' down-history
bindkey '^?' backward-delete-char
bindkey '^h' backward-delete-char
bindkey '^r' history-incremental-search-backward
bindkey '^a' vi-beginning-of-line
bindkey '^e' vi-end-of-line
bindkey '^f' forward-char
bindkey '^b' backward-char

bindkey -a 'j' backward-char
bindkey -a 'k' down-history
bindkey -a 'l' up-history
bindkey -a ';' forward-char
bindkey -a 'h' vi-repeat-find

# Compilation flags
# export ARCHFLAGS="-arch x86_64"

# ssh
# export SSH_KEY_PATH="~/.ssh/dsa_id"

###############
### ALIASES ###
###############

## Source config files ##
alias srcrc="source .zshrc"
alias srcx="xrdb -merge -I$HOME ~/.Xresources"
alias u="xrdb -merge -I$HOME ~/.Xresources; urxvt -e tmux"

## Resets the Xmodmap ##
alias asert="xmodmap $HOME/.Xmodmap;exit"
alias qwerty="xmodmap $HOME/.Xmodmap.backup;exit"

## Simple ls aliases ##
alias l="  /bin/ls -BF --color=always"
alias lb=" /bin/ls -F --color=always"
alias ls=" /bin/ls"
alias ll=" /bin/ls -BFlh --color=always"
alias la=" /bin/ls -FlAh --color=always"	# -A hides `.` and `..`
alias li=" /bin/ls -BFli --color=always"	# inode numbers
alias lia="/bin/ls -FliA --color=always"
alias lsl="/bin/ls -BF --color=always | cat"	# Displays on its own line

# Remove echo interpolation
alias echo="/bin/echo"

# Force multithreading by default.
alias make="make -j5"

alias shutdown="sudo shutdown 0"

# Same as manually typing `sudo !!'
alias plz='sudo $(fc -ln -1)'

## Arch aliases ##
alias pac="sudo pacman"
alias yao="yaourt"
alias syu="yaourt -Syua"

## Simple mount ##
alias mnt="sudo mount"
alias umnt="sudo umount"

## Systemctl ##
alias sc="sudo systemctl"
alias scu="systemctl --user"
alias lllp="systemctl suspend;exit" # Works fine for me lul

## One letter ##
alias g="git"
alias c="cd"
alias b=". b"
alias d="vimdiff"
alias x="exit"
alias v="vim"
alias p="ping 8.8.8.8"
alias s="sudo"
alias e="$EDITOR"
alias R="rm -Rf"

## Emacs stuff ##
alias se="sudoedit"
alias ek="emacsclient -e '(kill-emacs)'"
alias ed="cd;emacs --daemon"
alias er="cd;emacsclient -e '(kill-emacs)'; emacs --daemon; exit"

## Music ##
alias mu="ncmpcpp"
alias mux="ncmpcpp;exit"
alias am="alsamixer -c 0"
alias amx="alsamixer -c 0;exit"

## Systemctl ##
alias sc="sudo systemctl"
alias scu="systemctl --user"
alias scurx="systemctl --user restart xfluxd-args"
alias scusx="systemctl --user stop xfluxd-args"

## Grep aliases ##
alias grep=' /bin/grep  --color=always'
alias egrep='/bin/egrep --color=always'
alias fgrep='/bin/fgrep --color=always'

## Auto make and test ##
alias tmake="clear;make > /dev/null &&"

#################
### Functions ###
#################
cleanupemacs() {
    local _dir
    local dir
    for dir in $(find -maxdepth 1 -type d | sort | tail -n +2); do
        if [ "$_dir" = "$(echo "$dir" | perl -pe 's|^\./(.*?)[-]\d*?\.\d*?$|\1|')" ]; then
            rm -R "$dir"
        fi
        _dir="$(echo "$dir" | perl -pe 's|^\./(.*?)[-]\d*?\.\d*?$|\1|')"
    done
}

gri() {
    if [[ -n "$(git status -s)" ]]; then
        git stash
        git rebase -i "$@"
        git stash pop
    else
        git rebase -i "$@"
    fi
}

rb() {
    while (( $# > 0 )); do
        rm "$1"
        [ -e "$1"\~ ] && rm "$1"\~
        shift
    done
}

grH() {
    if [ $# == 0 ]; then
        git reset HEAD
    else
        git reset HEAD~$@
    fi
}

gp() {
    if [ -n "$(git status -s)" ]; then
	git stash
	git pull origin
	git stash pop
    else
	git pull origin
    fi
}

gst() {
    local _asert=''
    function gstFunction() {
        local _back="$(pwd)"
        cd "$di"
        if [ -d ".git" ]; then
            local _status="$(git status -sb)"
            local _branch="$(git branch --list | grep '^\*' | awk '{print $2}')"
            if [    "$_status" != "## ${_branch}" \
                 -a "$_status" != "## ${_branch}...origin/${_branch}" ]; then
                if [ ! -z "$_asert" ]; then
                    echo;echo
                    printf '\033[1;37m'
                    echo '- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -'
                    printf '\033[0m'
                else
                    _asert=' '
                fi
                printf '\033[1;37m'
                echo "$di:"
                printf '\033[0m'
                git status -sb
            fi
        fi
        cd "$_back"
    }
    for di in $(/bin/ls -A) '.'; do
        if [ -d "$di" -a "$di" != ".oh-my-zsh" ]; then
            gstFunction
        fi
    done
    unfunction gstFunction
}

gpss() {
    git push --set-upstream origin \
        $(git branch --list | grep '^\*' | awk '{print $2}')
}

gps() {
    function gpsFunction() {
        local _back="$(pwd)"
        cd "$di"
        if [ -d ".git" ]; then
            local _status _branch
            _status="$(git status -sb | head -n 1)"
            _branch="$(git branch --list | grep '^\*' | awk '{print $2}')"
            if [ -z "$_branch" ]; then _branch="master"; fi
            if [    "$_status" != "## ${_branch}" \
                 -a "$_status" != "## ${_branch}...origin/${_branch}" \
                 -a "$_status" != "## Initial commit on ${_branch}" ]; then
                echo
                printf '\033[1;37m'"$di:"'\033[0m\n'
                git push "$@"
                while [ $? -ne 0 ]; do git push "$@"; done
                echo
            fi
        fi
        cd "$_back"
    }
    for di in $(/bin/ls -A) '.'; do
        if [ -d "$di" -a "$di" != ".oh-my-zsh" ]; then
            gpsFunction "$@"
        fi
    done
    unfunction gpsFunction
}

findfile() {
    local _firstop
    _firstop="$(find -name "$@" -type f | head -n 1)"
    if [ -n "$_firstop" ]; then
        cd "$(dirname "$_firstop")"
    else
        _firstop="$(find -name "*$@*" -type f | head -n 1)"
        if [ -n "$_firstop" ]; then
            cd "$(dirname "$_firstop")"
        fi
    fi
    cd $(dirname `find -name "*$@*" | head -n 1`)
}

highlight() {
    perl -pe "s/($*)/$fg[red]\1$reset_color/g"
}

#Prints the columns specified
colm() {
    __cols="\$$1"
    shift
    while (( $# > 0 )); do
        __cols="$__cols, \$$1"
        shift
    done
    awk "{ print $__cols }"
}

#Auto `makedir` and `cd`.
mcd() {
    mkdir -p $@
    cd $@
}

thisdir() {
    echo $(if (( $# == 0 )); then pwd; else echo "$@"; fi | perl -pe 's/(.*\/)*(.*)/$2/')
}

grep2in() {
    flags="$1"; shift
    re="$1"; shift
    find "$@" -type f -not -name '*~' -print0 | xargs -0 grep "$flags" "$re"
}

grepin() {
    re="$1"; shift
    find "$@" -type f -not -name '*~' -print0 | xargs -0 grep "$re"
}

grepa2in() {
    flags="$1"; shift
    re="$1"; shift
    find "$@" -type f -print0 | xargs -0 grep "$flags" "$re"
}

grepain() {
    re="$1"; shift
    find "$@" -type f -print0 | xargs -0 grep "$re"
}

########################
### Auto Run Scripts ###
########################
b='\033[0;34m'
w='\033[0;31m'
g='\033[0;32m'
r='\033[0m'
printf "${b}(${g}let ${b}((${w}me${b}))${r}\n"
printf "  ${b}(${w}be ${b}(${g}free${b})))${r}\n"
unset b w g r

###############
### Sources ###
###############
[[ -s /home/czipperz/.autojump/etc/profile.d/autojump.sh ]] \
    && source /home/czipperz/.autojump/etc/profile.d/autojump.sh
# [[ -s /home/czipperz/.gvm/bin/gvm-init.sh ]] \
#     && source /home/czipperz/.gvm/bin/gvm-init.sh
autoload -U compinit && compinit -u
source /usr/share/zsh/plugins/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh
